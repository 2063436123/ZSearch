<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>ZSearch</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="stylesheet" href="sdk/sdk.css" />
    <link rel="stylesheet" href="sdk/helper.css" />
    <link rel="stylesheet" href="sdk/iconfont.css" />
    <!-- 这是默认主题所需的，如果是其他主题则不需要 -->
    <!-- 从 1.1.0 开始 sdk.css 将不支持 IE 11，如果要支持 IE11 请引用这个 css，并把前面那个删了 -->
    <!-- <link rel="stylesheet" href="sdk-ie11.css" /> -->
    <!-- 不过 amis 开发团队几乎没测试过 IE 11 下的效果，所以可能有细节功能用不了，如果发现请报 issue -->
    <style>
      html,
      body,
      .app-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="root" class="app-wrapper"></div>
    <script src="sdk/sdk.js"></script>
    <script type="text/javascript">
      (function () {
        let amis = amisRequire("amis/embed");
        // 通过替换下面这个配置来生成不同页面
        let amisJSON = {
          type: "page",
          data: {
            id: "${id}",
          },
          body: [
            {
              type: "tabs",
              tabsMode: "chrome",
              tabs: [
                {
                  title: "首页",
                  icon: "fa fa-home",
                  body: {
                    type: "page",
                    body: [
                      {
                        type: "divider",
                      },
                      {
                        type: "image",
                        imageMode: "original",
                        src: "HOST/zsearch_show.jpg",

                        // type: "chart",
                        // config: {
                        //   graphic: {
                        //     elements: [
                        //       {
                        //         type: "text",
                        //         left: "center",
                        //         top: "center",
                        //         style: {
                        //           text: "ZSearch",
                        //           fontSize: 150,
                        //           fontWeight: "bold",
                        //           lineDash: [0, 200],
                        //           lineDashOffset: 0,
                        //           fill: "transparent",
                        //           stroke: "#000",
                        //           lineWidth: 1,
                        //         },
                        //         keyframeAnimation: {
                        //           duration: 4000,
                        //           loop: false,
                        //           keyframes: [
                        //             {
                        //               percent: 0.7,
                        //               style: {
                        //                 fill: "transparent",
                        //                 lineDashOffset: 200,
                        //                 lineDash: [200, 0],
                        //               },
                        //             },
                        //             {
                        //               // Stop for a while.
                        //               percent: 0.8,
                        //               style: {
                        //                 fill: "transparent",
                        //               },
                        //             },
                        //             {
                        //               percent: 1,
                        //               style: {
                        //                 fill: "black",
                        //               },
                        //             },
                        //           ],
                        //         },
                        //       },
                        //     ],
                        //   },
                        // },
                      },
                    ],
                  },
                },
                {
                  title: "开始查询",
                  icon: "fa fa-search",
                  body: {
                    type: "page",
                    body: [
                      {
                        type: "divider",
                      },
                      {
                        type: "wrapper",
                        name: "my_form",
                        body: [
                          {
                            type: "tpl",
                            tpl: "<p>语法: term having expr limit number, 例如 'hello' HAVING AUTHOR() = 'jd' LIMIT 2; having value('author') = 'ljz'</p>"
                          },
                          {
                            type: "input-text",
                            name: "query",
                            placeholder: "输入查询语句",
                            clearable: true,
                            addOn: {
                              type: "button",
                              hidden: true,
                              actionType: "reload",
                              target: "my_form.table",
                            },
                          },
                          {
                            type: "service",
                            api: "HOST/start-query?query=$query&id=$id",
                            body: {
                              type: "table",
                              name: "table",
                              title: "查询结果",
                              source: "$results",
                              columns: [
                                {
                                  name: "doc_id",
                                  label: "文档编号",
                                },
                                {
                                  name: "path",
                                  label: "文档路径",
                                  copyable: true,
                                },
                                {
                                  name: "first_highlight_text",
                                  label: "第一条匹配文本",
                                },
                                {
                                  name: "score",
                                  label: "查询得分",
                                },
                              ],
                              itemActions: [
                                {
                                  // 预览
                                  type: "button",
                                  icon: "fa fa-eye",
                                  onEvent: {
                                    click: {
                                      actions: [
                                        {
                                          actionType: "drawer",
                                          drawer: {
                                            title: "文档信息",
                                            position: "left",
                                            size: "lg",
                                            resizable: true,
                                            showCloseButton: false,
                                            overlay: false,
                                            closeOnEsc: true,
                                            closeOnOutside: true,
                                            body: {
                                              type: "table",
                                              source: "$highlight_texts",
                                              columns: [
                                                {
                                                  name: "text",
                                                  label: "匹配文本",
                                                },
                                              ],
                                            },
                                            actions: [],
                                          },
                                        },
                                      ],
                                    },
                                  },
                                },
                                {
                                  // 下载文件
                                  type: "button",
                                  icon: "fa fa-download",
                                  onEvent: {
                                    click: {
                                      actions: [
                                        {
                                          actionType: "ajax",
                                          args: {
                                            api: {
                                              method: "download",
                                              // TODO: 传递文档编号而非路径
                                              url: "HOST/download-document?doc_id=$doc_id&id=$id",
                                            },
                                          },
                                        },
                                        {
                                          componentId: "u:90adflsdfsf",
                                          actionType: "reload",
                                          dataMergeMode: "override",
                                        },
                                      ],
                                    },
                                  },
                                },
                              ],
                            },
                          },
                        ],
                      },
                    ],
                  },
                },
                {
                  title: "索引管理",
                  icon: "fa fa-indent",
                  body: {
                    type: "page",
                    body: [
                      {
                        type: "divider",
                      },
                      {
                        type: "service",
                        api: "HOST/get-all-index?id=$id",
                        id: "u:8373741bf5cf",
                        body: [
                          {
                            type: "table",
                            source: "$paths",
                            columnsTogglable: false,
                            columns: [
                              {
                                label: "索引路径",
                                name: "path",
                                copyable: true,
                                fixed: "left",
                              },
                              {
                                label: "索引文档总数",
                                name: "document_number",
                              },
                              {
                                label: "最近修改时间",
                                name: "mtime",
                              },
                            ],
                            itemActions: [
                              {
                                // 预览
                                type: "button",
                                icon: "fa fa-eye",
                                onEvent: {
                                  click: {
                                    actions: [
                                      {
                                        actionType: "ajax",
                                        args: {
                                          api: {
                                            method: "get",
                                            url: "HOST/get-index-info?path=${path}&id=$id",
                                          },
                                        },
                                      },
                                      {
                                        actionType: "drawer",
                                        drawer: {
                                          title: "文档信息",
                                          position: "left",
                                          size: "lg",
                                          resizable: true,
                                          showCloseButton: false,
                                          overlay: false,
                                          closeOnEsc: true,
                                          closeOnOutside: true,
                                          body: {
                                            type: "table",
                                            source: "$infos",
                                            columns: [
                                              {
                                                name: "id",
                                                label: "文档编号",
                                              },
                                              {
                                                name: "path",
                                                label: "文档路径",
                                                copyable: true,
                                              },
                                            ],
                                          },
                                          actions: [],
                                        },
                                      },
                                    ],
                                  },
                                },
                              },

                              // {
                              //   // 上传文件
                              //   type: "button",
                              //   icon: "fa fa-cloud-upload",
                              //   onEvent: {
                              //     click: {
                              //       actions: [
                              //         {
                              //           type: "input-file",
                              //           name: "file",
                              //           label: "File",
                              //           accept: "*",
                              //           receiver: "/amis/api/upload/file",
                              //           drag: true,
                              //         },
                              //         {
                              //           componentId: "u:8373741bf5cf",
                              //           actionType: "reload",
                              //           dataMergeMode: "override",
                              //         },
                              //       ],
                              //     },
                              //   },
                              // },
                              {
                                // 删除按钮
                                type: "button",
                                icon: "fa fa-times",
                                onEvent: {
                                  click: {
                                    actions: [
                                      {
                                        actionType: "ajax",
                                        args: {
                                          api: {
                                            method: "get",
                                            url: "HOST/remove-index?path=${path}&id=$id",
                                          },
                                        },
                                      },
                                      {
                                        componentId: "u:8373741bf5cf",
                                        actionType: "reload",
                                        dataMergeMode: "override",
                                      },
                                      {
                                        componentId: "u:12ijo3j1o2d",
                                        actionType: "reload",
                                        dataMergeMode: "override",
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        ],
                      },
                      {
                        type: "button",
                        label: "刷新",
                        onEvent: {
                          click: {
                            weight: 0,
                            actions: [
                              {
                                componentId: "u:8373741bf5cf",
                                actionType: "reload",
                                dataMergeMode: "override",
                              },
                              {
                                componentId: "u:12ijo3j1o2d",
                                actionType: "reload",
                                dataMergeMode: "override",
                              },
                            ],
                          },
                        },
                      },
                      {
                        label: "重建数据库",
                        type: "button",
                        onEvent: {
                          click: {
                            actions: [
                              {
                                actionType: "dialog",
                                dialog: {
                                  body: "确认要重建数据库吗 —— 已有的统计信息也会被删除",
                                  onEvent: {
                                    confirm: {
                                      actions: [
                                        {
                                          actionType: "ajax",
                                          args: {
                                            api: {
                                              method: "get",
                                              url: "HOST/rebuild-all-index?id=$id",
                                            },
                                          },
                                        },
                                        {
                                          componentId: "u:8373741bf5cf",
                                          actionType: "reload",
                                          dataMergeMode: "override",
                                        },
                                        {
                                          componentId: "u:12ijo3j1o2d",
                                          actionType: "reload",
                                          dataMergeMode: "override",
                                        },
                                        {
                                          componentId: "u:90adflsdfsf",
                                          actionType: "reload",
                                          dataMergeMode: "override",
                                        },
                                      ],
                                    },
                                  },
                                },
                              },
                            ],
                          },
                        },
                        // actionType: "ajax",
                        // confirmText: "确认要重新索引所有条目 —— 可能需要一段时间",
                        // api: { method: "get", url: "HOST/rebuild-all-index" },
                      },
                      {
                        label: "添加监听目录",
                        hotKey: "enter",
                        type: "button",
                        onEvent: {
                          click: {
                            actions: [
                              {
                                actionType: "dialog",
                                dialog: {
                                  title: "",
                                  closeOnEsc: true,
                                  closeOnOutside: true,
                                  body: {
                                    type: "form",
                                    api: "HOST/add-index?id=$id",
                                    id: "u:651asdfsadf",
                                    autoFocus: true,
                                    body: [
                                      {
                                        type: "input-text",
                                        name: "path",
                                        label: "文件夹路径",
                                        placeholder: "绝对路径，以 / 开头",
                                        required: true,
                                        validateOnChange: true,
                                      },
                                    ],
                                    onEvent: {
                                      submitSucc: {
                                        actions: [
                                          {
                                            componentId: "u:8373741bf5cf",
                                            actionType: "reload",
                                            dataMergeMode: "override",
                                          },
                                          {
                                            componentId: "u:12ijo3j1o2d",
                                            actionType: "reload",
                                            dataMergeMode: "override",
                                          },
                                        ],
                                      },
                                    },
                                  },
                                },
                              },
                            ],
                          },
                        },
                      },
                    ],
                  },
                },
                {
                  title: "统计分析",
                  icon: "fa fa-bar-chart",
                  body: {
                    type: "page",
                    body: [
                      {
                        type: "divider",
                      },
                      {
                        type: "grid",
                        // justify: "space-evenly",
                        columns: [
                          {
                            type: "chart",
                            id: "u:12ijo3j1o2d",
                            api: "HOST/get-type-statistics?id=$id",
                            config: {
                              title: {
                                text: "文件类型统计",
                                left: "center",
                              },
                              tooltip: {
                                trigger: "item",
                              },
                              legend: {
                                orient: "vertical",
                                left: "left",
                              },
                              series: [
                                {
                                  type: "pie",
                                  radius: "50%",
                                  data: "$results",
                                  emphasis: {
                                    itemStyle: {
                                      shadowBlur: 10,
                                      shadowOffsetX: 0,
                                      shadowColor: "rgba(0, 0, 0, 0.5)",
                                    },
                                  },
                                },
                              ],
                            },
                          },
                          {
                            type: "service",
                            id: "u:90adflsdfsf",
                            api: "HOST/get-document-freq-statistics?id=$id",
                            body: {
                              type: "table",
                              title: "最热门文档",
                              className: "font-bold",
                              source: "$results",
                              columns: [
                                {
                                  label: "文件名",
                                  name: "doc_name",
                                  popOver: {
                                    body: {
                                      type: "tpl",
                                      tpl: "${doc_path}",
                                    },
                                  },
                                },
                                {
                                  label: "检索量",
                                  name: "query_freq",
                                },
                                {
                                  label: "下载量",
                                  name: "download_freq",
                                },
                              ],
                              itemActions: [
                                {
                                  // 下载文件
                                  type: "button",
                                  icon: "fa fa-download",
                                  onEvent: {
                                    click: {
                                      actions: [
                                        {
                                          actionType: "ajax",
                                          args: {
                                            api: {
                                              method: "download",
                                              url: "HOST/download-document?doc_id=$doc_id&id=$id",
                                            },
                                          },
                                        },
                                        {
                                          componentId: "u:90adflsdfsf",
                                          actionType: "reload",
                                          dataMergeMode: "override",
                                        },
                                      ],
                                    },
                                  },
                                },
                              ],
                            },
                          },
                        ],
                      },
                      {
                        type: "divider",
                      },
                      {
                        type: "chart",
                        api: "HOST/get-query-statistics?id=$id",
                        interval: 14000,
                        height: 500,
                        config: {
                          title: {
                            text: "查询效率统计",
                            left: "center",
                          },
                          tooltip: {
                            trigger: "axis",
                            axisPointer: {
                              animation: false,
                              label: {
                                show: true,
                              },
                            },
                          },
                          legend: {
                            data: ["ElapsedTime", "ResultNum"],
                            left: 10,
                          },
                          toolbox: {
                            feature: {
                              dataZoom: {
                                yAxisIndex: "none",
                              },
                              restore: {},
                              saveAsImage: {},
                            },
                          },
                          axisPointer: {
                            link: [
                              {
                                xAxisIndex: "all",
                              },
                            ],
                          },
                          dataZoom: [
                            {
                              show: true,
                              realtime: true,
                              start: 0,
                              end: 100,
                              xAxisIndex: [0, 1],
                            },
                            {
                              type: "inside",
                              realtime: true,
                              start: 0,
                              end: 100,
                              xAxisIndex: [0, 1],
                            },
                          ],
                          grid: [
                            {
                              left: 60,
                              right: 50,
                              height: "30%",
                            },
                            {
                              left: 60,
                              right: 50,
                              top: "53%",
                              height: "30%",
                            },
                          ],
                          xAxis: [
                            {
                              type: "category",
                              boundaryGap: false,
                              axisLine: { onZero: true },
                              data: "$x_strings",
                            },
                            {
                              gridIndex: 1,
                              type: "category",
                              boundaryGap: false,
                              axisLine: { onZero: true },
                              data: "$x_strings",
                              position: "top",
                            },
                          ],
                          yAxis: [
                            {
                              name: "ElapsedTime(ms)",
                              type: "value",
                            },
                            {
                              gridIndex: 1,
                              name: "ResultNum",
                              type: "value",
                              inverse: true,
                            },
                          ],
                          series: [
                            {
                              name: "ElapsedTime",
                              type: "line",
                              symbolSize: 8,
                              // prettier-ignore
                              data: "${elapsed_time_vals}",
                              areaStyle: {},
                            },
                            {
                              name: "ResultNum",
                              type: "line",
                              xAxisIndex: 1,
                              yAxisIndex: 1,
                              symbolSize: 8,
                              // prettier-ignore
                              data: "${result_num_vals}",
                              areaStyle: {},
                            },
                          ],
                        },
                      },
                    ],
                  },
                },
              ],
            },
          ],
        };
        let amisScoped = amis.embed(
          "#root",
          amisJSON,
          {},
          {
            replaceText: {
              HOST: "http://localhost:8080",
            },
          }
        );
        // more actions
      })();
    </script>
  </body>
</html>
