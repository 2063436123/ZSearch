<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>ZSearch</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="stylesheet" href="sdk/sdk.css" />
    <link rel="stylesheet" href="sdk/helper.css" />
    <link rel="stylesheet" href="sdk/iconfont.css" />
    <!-- 这是默认主题所需的，如果是其他主题则不需要 -->
    <!-- 从 1.1.0 开始 sdk.css 将不支持 IE 11，如果要支持 IE11 请引用这个 css，并把前面那个删了 -->
    <!-- <link rel="stylesheet" href="sdk-ie11.css" /> -->
    <!-- 不过 amis 开发团队几乎没测试过 IE 11 下的效果，所以可能有细节功能用不了，如果发现请报 issue -->
    <style>
      html,
      body,
      .app-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="root" class="app-wrapper"></div>
    <script src="sdk/sdk.js"></script>
    <script type="text/javascript">
      (function () {
        let amis = amisRequire("amis/embed");
        // 通过替换下面这个配置来生成不同页面
        let amisJSON = {
          type: "page",
          data: {
            id: "${id}",
          },
          body: [
            {
              type: "tabs",
              tabsMode: "chrome",
              tabs: [
                {
                  title: "开始查询",
                  icon: "fa fa-search",
                  body: {
                    type: "page",
                    body: [
                      {
                        type: "divider",
                      },
                      {
                        type: "wrapper",
                        name: "my_form",
                        body: [
                          {
                            type: "input-text",
                            name: "query",
                            placeholder: "输入查询语句",
                            clearable: true,
                            addOn: {
                              type: "button",
                              hidden: true,
                              actionType: "reload",
                              target: "my_form.table",
                            },
                          },
                          {
                            type: "service",
                            api: "HOST/start-query?query=$query&id=$id",
                            body: {
                              type: "table",
                              name: "table",
                              title: "查询结果",
                              source: "$results",
                              columns: [
                                {
                                  name: "doc_id",
                                  label: "文档编号",
                                },
                                {
                                  name: "path",
                                  label: "文档路径",
                                  copyable: true,
                                },
                                {
                                  name: "first_highlight_text",
                                  label: "第一条匹配文本",
                                },
                                {
                                  name: "score",
                                  label: "查询得分",
                                },
                              ],
                              itemActions: [
                                {
                                  // 预览
                                  type: "button",
                                  icon: "fa fa-eye",
                                  onEvent: {
                                    click: {
                                      actions: [
                                        {
                                          actionType: "drawer",
                                          drawer: {
                                            title: "文档信息",
                                            position: "left",
                                            size: "lg",
                                            resizable: true,
                                            showCloseButton: false,
                                            overlay: false,
                                            closeOnEsc: true,
                                            closeOnOutside: true,
                                            body: {
                                              type: "table",
                                              source: "$highlight_texts",
                                              columns: [
                                                {
                                                  name: "text",
                                                  label: "匹配文本",
                                                },
                                              ],
                                            },
                                            actions: [],
                                          },
                                        },
                                      ],
                                    },
                                  },
                                },
                                {
                                  // 下载文件
                                  type: "button",
                                  icon: "fa fa-download",
                                  onEvent: {
                                    click: {
                                      actions: [
                                        {
                                          actionType: "ajax",
                                          args: {
                                            api: {
                                              method: "download",
                                              // TODO: 传递文档编号而非路径
                                              url: "HOST/download-document?doc_id=$doc_id&id=$id",
                                            },
                                          },
                                        },
                                      ],
                                    },
                                  },
                                },
                              ],
                            },
                          },
                        ],
                      },
                    ],
                  },
                },
                {
                  title: "索引管理",
                  icon: "fa fa-indent",
                  body: {
                    type: "page",
                    body: [
                      {
                        type: "divider",
                      },
                      {
                        type: "service",
                        api: "HOST/get-all-index?id=$id",
                        id: "u:8373741bf5cf",
                        body: [
                          {
                            type: "table",
                            source: "$paths",
                            columnsTogglable: false,
                            columns: [
                              {
                                label: "索引路径",
                                name: "path",
                                copyable: true,
                                fixed: "left",
                              },
                              {
                                label: "索引文档总数",
                                name: "document_number",
                              },
                              {
                                label: "最近修改时间",
                                name: "mtime",
                              },
                            ],
                            itemActions: [
                              {
                                // 预览
                                type: "button",
                                icon: "fa fa-eye",
                                onEvent: {
                                  click: {
                                    actions: [
                                      {
                                        actionType: "ajax",
                                        args: {
                                          api: {
                                            method: "get",
                                            url: "HOST/get-index-info?path=${path}&id=$id",
                                          },
                                        },
                                      },
                                      {
                                        actionType: "drawer",
                                        drawer: {
                                          title: "文档信息",
                                          position: "left",
                                          size: "lg",
                                          resizable: true,
                                          showCloseButton: false,
                                          overlay: false,
                                          closeOnEsc: true,
                                          closeOnOutside: true,
                                          body: {
                                            type: "table",
                                            source: "$infos",
                                            columns: [
                                              {
                                                name: "id",
                                                label: "文档编号",
                                              },
                                              {
                                                name: "path",
                                                label: "文档路径",
                                                copyable: true,
                                              },
                                            ],
                                          },
                                          actions: [],
                                        },
                                      },
                                    ],
                                  },
                                },
                              },

                              // {
                              //   // 上传文件
                              //   type: "button",
                              //   icon: "fa fa-cloud-upload",
                              //   onEvent: {
                              //     click: {
                              //       actions: [
                              //         {
                              //           type: "input-file",
                              //           name: "file",
                              //           label: "File",
                              //           accept: "*",
                              //           receiver: "/amis/api/upload/file",
                              //           drag: true,
                              //         },
                              //         {
                              //           componentId: "u:8373741bf5cf",
                              //           actionType: "reload",
                              //           dataMergeMode: "override",
                              //         },
                              //       ],
                              //     },
                              //   },
                              // },
                              {
                                // 删除按钮
                                type: "button",
                                icon: "fa fa-times",
                                onEvent: {
                                  click: {
                                    actions: [
                                      {
                                        actionType: "ajax",
                                        args: {
                                          api: {
                                            method: "get",
                                            url: "HOST/remove-index?path=${path}&id=$id",
                                          },
                                        },
                                      },
                                      {
                                        componentId: "u:8373741bf5cf",
                                        actionType: "reload",
                                        dataMergeMode: "override",
                                      },
                                    ],
                                  },
                                },
                              },
                            ],
                          },
                        ],
                      },
                      {
                        type: "button",
                        label: "刷新",
                        onEvent: {
                          click: {
                            weight: 0,
                            actions: [
                              {
                                componentId: "u:8373741bf5cf",
                                actionType: "reload",
                                dataMergeMode: "override",
                              },
                            ],
                          },
                        },
                      },
                      {
                        label: "重新索引",
                        type: "button",
                        onEvent: {
                          click: {
                            actions: [
                              {
                                actionType: "dialog",
                                dialog: {
                                  body: "确认要重新索引所有条目吗 —— 可能需要一段时间",
                                  onEvent: {
                                    confirm: {
                                      actions: [
                                        {
                                          actionType: "ajax",
                                          args: {
                                            api: {
                                              method: "get",
                                              url: "HOST/rebuild-all-index?id=$id",
                                            },
                                          },
                                        },
                                        {
                                          componentId: "u:8373741bf5cf",
                                          actionType: "reload",
                                          dataMergeMode: "override",
                                        },
                                      ],
                                    },
                                  },
                                },
                              },
                            ],
                          },
                        },
                        // actionType: "ajax",
                        // confirmText: "确认要重新索引所有条目 —— 可能需要一段时间",
                        // api: { method: "get", url: "HOST/rebuild-all-index" },
                      },
                      {
                        label: "添加监听目录",
                        hotKey: "enter",
                        type: "button",
                        onEvent: {
                          click: {
                            actions: [
                              {
                                actionType: "dialog",
                                dialog: {
                                  title: "",
                                  closeOnEsc: true,
                                  closeOnOutside: true,
                                  body: {
                                    type: "form",
                                    api: "HOST/add-index?id=$id",
                                    id: "u:651asdfsadf",
                                    autoFocus: true,
                                    body: [
                                      {
                                        type: "input-text",
                                        name: "path",
                                        label: "文件夹路径",
                                        placeholder: "绝对路径，以 / 开头",
                                        required: true,
                                        validateOnChange: true,
                                      },
                                    ],
                                    onEvent: {
                                      submitSucc: {
                                        actions: [
                                          {
                                            componentId: "u:8373741bf5cf",
                                            actionType: "reload",
                                            dataMergeMode: "override",
                                          },
                                        ],
                                      },
                                    },
                                  },
                                },
                              },
                            ],
                          },
                        },
                      },
                    ],
                  },
                },
                {
                  title: "统计分析",
                  icon: "fa fa-bar-chart",
                  body: {
                    type: "audio",
                    src: "HOST/yzcw.mp3",
                  },
                },
              ],
            },
          ],
        };
        let amisScoped = amis.embed(
          "#root",
          amisJSON,
          {},
          {
            replaceText: {
              HOST: "http://localhost:8080",
            },
          }
        );
        // more actions
      })();
    </script>
  </body>
</html>
